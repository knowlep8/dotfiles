# vim: ft=zsh

local arg
local libtool

# Find first option argument and check whether we have a --args argument
first_arg=
second_arg=
has_args_arg=
for arg in $argv; do
    if [ $arg = "--args" ]; then
        has_args_arg=1
    elif [ -n "$first_arg" -a -z "$second_arg" ]; then
        second_arg=$arg
    fi
    if [ -z "$first_arg" -a $arg[1] != "-" ]; then
        first_arg=$arg
    fi
done

#echo first_arg: $first_arg
#echo second_arg: $second_arg
#echo has_args_arg: $has_args_arg
if [ -z "$has_args_arg" -a -n "$second_arg" ]; then
    file -i -- $second_arg | grep 'application/x-coredump'
    if [ $? -ne 0 ]; then
        echo "$second_arg: not a core dump.  Assuming you want --args."
        argv=(--args $argv)
    fi
fi

if [[ -f $first_arg ]] && file $first_arg | grep "Bourne shell script text executable" &> /dev/null; then
    if head $first_arg | grep "Generated by ltmain.sh - GNU libtool" &> /dev/null; then
        echo "$first_arg: libtool wrapper."
        libtool=(libtool --mode=execute)
    fi
fi

[ "$libtool" ] && echo $libtool $0 ${(qqq)argv}
command $libtool $0 $argv
